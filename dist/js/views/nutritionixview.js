$(function(){"use strict";window.app=window.app||{};var e=13;window.app.FoodView=Backbone.View.extend({tagName:"li",events:{click:"toggleFood"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){this.$el.addClass("food-left");var e={title:this.model.get("title"),calories:this.model.get("calories")},t='<input type="checkbox" class="food-left-input" value="1" name="<%= title %>"> <%= title %><span class="food-left-span">cal <%= calories %></span>',o=_.template(t);return this.$el.html(o(e)),this.$("input").prop("checked",this.model.get("checked")),this},toggleFood:function(){if(this.model.toggle(),this.model.get("checked")){var e=new window.app.FoodStore({title:this.model.get("title"),calories:this.model.get("calories")});window.app.foodsRight.add(e),e.save()}else window.app.foodsRight.remove(this.model.get("title"))}}),window.app.FoodStoreView=Backbone.View.extend({tagName:"li",render:function(){this.$el.addClass("food-right");var e={title:this.model.get("title"),calories:this.model.get("calories")},t=_.template('<div name="<%= title %>"> <%= title %><span class="food-right-span">cal <%= calories %></span></div>');return this.$el.html(t(e)),this}}),window.app.SearchView=Backbone.View.extend({tagName:"header",events:{"keydown .search":"search"},search:function(t){if(t.which===e){$(".box:nth-of-type(1)").prepend('<div class="loading"></div>');var o=this.$(".search").val().toLowerCase();Backbone.ajax({type:"GET",url:"https://api.nutritionix.com/v1_1/search/"+o+"?results=0:20&fields=item_name,nf_calories&appId=798c174d&appKey=c611abeca967abfb180066d0ba82e589",dataType:"json"}).done(function(e){e.hits.length>0?(_.invoke(window.app.foodsLeft.toArray(),"destroy"),window.app.appView.remove(),e.hits.forEach(function(e){var t=e.fields,o=!1;window.app.foodsRight.each(function(e){e.get("title")===t.item_name&&(o=!0)}),window.app.foodsLeft.add(new window.app.Food({title:t.item_name,calories:t.nf_calories,checked:o}))})):window.app.appView.renderError(void 0),setTimeout(function(){$(".loading").remove()},500)}).fail(function(e){$(".loading").remove(),window.app.appView.renderError(e)})}},render:function(){return this.$el.html('<h1 class="head-title">Search food: <input type="text" class="search"></h1>'),this}}),window.app.AppView=Backbone.View.extend({el:$("body"),initialize:function(){window.app.foodsRight.fetch(),this.listLeft=$(".foods-left"),this.totalRight=$(".total-right-span"),this.listRight=$(".foods-right"),this.search=$("header"),this.error=$(".error-msg"),$(".foods-left:empty").parent().css("display","none"),0===window.app.foodsRight.length&&$(".foods-right:empty").parent().css("visibility","hidden");var e=new window.app.SearchView;this.search.append(e.render().el),this.listenTo(window.app.foodsLeft,"add",this.renderAddLeft),this.listenTo(window.app.foodsRight,"add remove",this.renderAddRemoveRight),this.listenTo(window.app.foodsLeft,"change",this.renderChange);var t=0;window.app.foodsRight.each(function(e){t+=e.get("calories"),window.app.foodStoreView=new window.app.FoodStoreView({model:e}),this.listRight.append(window.app.foodStoreView.render().el)},this),$(".total-right").empty();var o={totalRight:t.toFixed(2)},i=_.template('total cal: <span class="total-right-span"> <%= totalRight %></span>');$(".total-right").append(i(o))},renderAddLeft:function(){var e=window.app.foodsLeft.length-1,t=new window.app.FoodView({model:window.app.foodsLeft.models[e]});return this.listLeft.append(t.render().el),e>0&&$(".foods-left").parent().css("display","block"),this},renderAddRemoveRight:function(){$(".foods-right").empty();for(var e=0;window.app.foodsRight.length>e;e++)window.app.foodStoreView=new window.app.FoodStoreView({model:window.app.foodsRight.models[e]}),this.listRight.append(window.app.foodStoreView.render().el);return window.app.foodsRight.length>0?$(".foods-right").parent().css("visibility","visible"):$(".foods-right:empty").parent().css("visibility","hidden"),this},renderChange:function(e){var t=0;return window.app.foodsRight.each(function(e){t+=e.get("calories")}),void 0!==e.attributes&&(e.attributes.checked?t+=e.attributes.calories:t-=e.attributes.calories),$(".total-right").empty(),$(".total-right").append('total cal: <span class="total-right-span"> '+t.toFixed(2)+"</span>"),$(".foods-left").empty(),$(".foods-left:empty").parent().css("display","none"),this},remove:function(){$(".foods-left").empty()},renderError:function(e){var t=void 0!==e&&""!==e.responseText?JSON.parse(e.responseText):void 0,o=void 0!==t?t.error_message:"Nutritionix didn't send back any data",i=void 0!==e?e.statusText:"error",a=void 0!==e?e.status:0,s={statusTextData:i,statusData:a,errorMessageData:o},d='<div class="alert alert-danger fade in"><a href="#" class="close" data-dismiss="alert">&times;</a><strong>Error: </strong><%= statusTextData %> <br><strong>Code: </strong><%= statusData %><br><strong>Message: </strong><%= errorMessageData %></div>',n=_.template(d);return this.error.html(n(s)),this}})});
$(function(){var e,t,i,o=13,n=Backbone.Model.extend({defaults:{title:"",calories:0,checked:!1},toggle:function(){this.set("checked",!this.get("checked"))}}),r=Backbone.Collection.extend({model:n,add:function(e){var t=this.any(function(t){return t.get("title")===e.get("title")});return t?!1:(Backbone.Collection.prototype.add.call(this,e),void 0)},getChecked:function(){return this.where({checked:!0})}});t=new r([]);var s=Backbone.View.extend({tagName:"li",events:{click:"toggleFood"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html('<input type="checkbox" value="1" name="'+this.model.get("title")+'" > '+this.model.get("title")+"<span>cal "+this.model.get("calories")+"</span>"),this.$("input").prop("checked",this.model.get("checked")),this},toggleFood:function(){if(this.model.toggle(),this.model.get("checked")){var e=new a({title:this.model.get("title"),calories:this.model.get("calories")});i.add(e),e.save()}else i.remove(this.model.get("title"))}}),a=Backbone.Model.extend({defaults:{title:"",calories:0}}),d=Backbone.Collection.extend({model:a,localStorage:new Backbone.LocalStorage("food-list"),add:function(e){var t=this.any(function(t){return t.get("title")===e.get("title")});return t?!1:(Backbone.Collection.prototype.add.call(this,e),void 0)},remove:function(e){var t=this;t.each(function(i,o){i.get("title")===e&&t.at(o).destroy()}),Backbone.Collection.prototype.remove.call(t,e)}});i=new d,i.fetch();var l=Backbone.View.extend({tagName:"li",render:function(){return this.$el.html('<div name="'+this.model.get("title")+'" > '+this.model.get("title")+"<span>cal "+this.model.get("calories")+"</span></div>"),this}}),c=Backbone.View.extend({tagName:"header",events:{"keydown .search":"search"},search:function(e){if(e.which===o){$("div.box:nth-of-type(1)").prepend('<div class="loading"></div>');var r=this.$(".search").val().toLowerCase();Backbone.ajax({type:"GET",url:"https://api.nutritionix.com/v1_1/search/"+r+"?results=0:20&fields=item_name,nf_calories&appId=798c174d&appKey=c611abeca967abfb180066d0ba82e589",dataType:"json"}).done(function(e){e.hits.length>0?(_.invoke(t.toArray(),"destroy"),g.remove(),e.hits.forEach(function(e){var o=e.fields,r=!1;i.each(function(e){e.get("title")===o.item_name&&(r=!0)}),t.add(new n({title:o.item_name,calories:o.nf_calories,checked:r}))})):g.renderError(void 0),setTimeout(function(){$(".loading").remove()},500)}).fail(function(e){$(".loading").remove(),g.renderError(e)})}},render:function(){return this.$el.html('<h1 id="headTitle">Search food: <input type="text" class="search"></h1>'),this}}),h=Backbone.View.extend({el:$("body"),initialize:function(){this.listLeft=$("#foods-left"),this.totalRight=$("#total-right span"),this.listRight=$("#foods-right"),this.search=$("header"),this.error=$("div.error-msg"),$("ul#foods-left:empty").parent().css("display","none"),0===i.length&&$("ul#foods-right:empty").parent().css("visibility","hidden");var e=new c;this.search.append(e.render().el),this.listenTo(t,"add",this.renderAddLeft),this.listenTo(i,"add remove",this.renderAddRemoveRight),this.listenTo(t,"change",this.renderChange);var o=0;i.each(function(e){o+=e.get("calories"),foodStoreView=new l({model:e}),this.listRight.append(foodStoreView.render().el)},this),$("p#total-right").empty(),$("p#total-right").append("total cal: <span> "+o.toFixed(2)+"</span>")},renderAddLeft:function(){var i=t.length-1;return e=new s({model:t.models[i]}),this.listLeft.append(e.render().el),i>0&&$("ul#foods-left").parent().css("display","block"),this},renderAddRemoveRight:function(){$("#foods-right").empty();for(var e=0;i.length>e;e++)foodStoreView=new l({model:i.models[e]}),this.listRight.append(foodStoreView.render().el);return i.length>0?$("ul#foods-right").parent().css("visibility","visible"):$("ul#foods-right:empty").parent().css("visibility","hidden"),this},renderChange:function(e){var t=0;return i.each(function(e){t+=e.get("calories")}),void 0!==e.attributes&&(e.attributes.checked?t+=e.attributes.calories:t-=e.attributes.calories),$("p#total-right").empty(),$("p#total-right").append("total cal: <span> "+t.toFixed(2)+"</span>"),$("#foods-left").empty(),$("ul#foods-left:empty").parent().css("display","none"),this},remove:function(){$("#foods-left").empty()},renderError:function(e){var t=void 0!==e&&""!==e.responseText?JSON.parse(e.responseText):void 0,i=void 0!==t?t.error_message:"Nutritionix didn't send back any data",o=void 0!==e?e.statusText:"error",n=void 0!==e?e.status:0,r='<div class="alert alert-danger fade in"><a href="#" class="close" data-dismiss="alert">&times;</a><strong>Error: </strong>'+o+" <br><strong>Code: </strong>"+n+"<br>"+"<strong>Message: </strong>"+i+"</div>";return this.error.html(r),this}}),g=new h});